<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字转 Markdown 工具</title>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://unpkg.com/turndown-plugin-gfm/dist/turndown-plugin-gfm.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .mode-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-tab {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .mode-tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .mode-tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            color: #333;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd6;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .panel-body {
            padding: 0;
        }

        /* 富文本输入区域 */
        .rich-input {
            min-height: 400px;
            padding: 20px;
            outline: none;
            font-size: 1rem;
            line-height: 1.6;
            overflow-y: auto;
            max-height: 500px;
        }

        .rich-input:empty:before {
            content: attr(data-placeholder);
            color: #adb5bd;
        }

        .rich-input:focus {
            background: #fafbfc;
        }

        /* HTML 输入区域 */
        .html-input {
            width: 100%;
            min-height: 400px;
            max-height: 500px;
            padding: 20px;
            border: none;
            outline: none;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: none;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .html-input::placeholder {
            color: #6a6a6a;
        }

        /* Markdown 输出区域 */
        .markdown-output {
            width: 100%;
            min-height: 400px;
            max-height: 500px;
            padding: 20px;
            border: none;
            outline: none;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: none;
            background: #fafbfc;
        }

        .hidden {
            display: none !important;
        }

        /* Toast 提示 */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* 选项设置 */
        .options {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
        }

        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .option-item select {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            font-size: 0.85rem;
        }

        /* 拖拽提示 */
        .drop-hint {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(102, 126, 234, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .drop-hint.show {
            opacity: 1;
        }

        .input-panel {
            position: relative;
        }

        /* SEO 工具样式 */
        .seo-container {
            display: none;
            gap: 20px;
        }

        .seo-container.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 900px) {
            .seo-container.active {
                grid-template-columns: 1fr;
            }
        }

        .seo-tool {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .seo-tool-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .seo-tool-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .seo-tool-subtitle {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .seo-tool-body {
            padding: 20px;
        }

        .seo-input-group {
            margin-bottom: 16px;
        }

        .seo-input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .seo-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .seo-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .seo-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .seo-output-group {
            margin-top: 16px;
        }

        .seo-output-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .seo-output-label span {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .seo-output {
            width: 100%;
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: #495057;
            word-break: break-all;
        }

        .char-count {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .char-count.warning {
            color: #fd7e14;
        }

        .char-count.danger {
            color: #dc3545;
        }

        /* Google 搜索预览样式 */
        .serp-preview {
            background: white;
            border: 1px solid #dfe1e5;
            border-radius: 8px;
            padding: 16px;
            font-family: Arial, sans-serif;
            margin-top: 16px;
        }

        .serp-preview-title {
            display: block;
            font-size: 20px;
            line-height: 1.3;
            color: #1a0dab;
            text-decoration: none;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .serp-preview-url {
            font-size: 14px;
            color: #006621;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .serp-preview-description {
            font-size: 14px;
            line-height: 1.58;
            color: #545454;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .serp-label {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .slug-options {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .slug-option {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            color: #495057;
        }

        .slug-option input {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>文字转 Markdown 工具</h1>
        <p class="subtitle">支持从 Google Docs 粘贴富文本，或直接输入 HTML 代码</p>

        <div class="mode-tabs">
            <button class="mode-tab active" data-mode="rich">富文本粘贴</button>
            <button class="mode-tab" data-mode="html">HTML 代码</button>
            <button class="mode-tab" data-mode="debug">查看原始 HTML</button>
            <button class="mode-tab" data-mode="seo">SEO 工具</button>
        </div>

        <div class="options">
            <label class="option-item">
                <input type="checkbox" id="opt-gfm" checked>
                GitHub 风格 (GFM)
            </label>
            <label class="option-item">
                <input type="checkbox" id="opt-code-fence" checked>
                代码块使用围栏
            </label>
            <label class="option-item">
                标题风格:
                <select id="opt-heading">
                    <option value="atx">ATX (# 标题)</option>
                    <option value="setext">Setext (下划线)</option>
                </select>
            </label>
            <label class="option-item">
                列表符号:
                <select id="opt-bullet">
                    <option value="-">- (短横线)</option>
                    <option value="*">* (星号)</option>
                    <option value="+">+ (加号)</option>
                </select>
            </label>
        </div>

        <div class="main-content">
            <div class="panel input-panel">
                <div class="panel-header">
                    <span class="panel-title" id="input-title">输入 (粘贴富文本)</span>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" id="btn-clear">清空</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div
                        class="rich-input"
                        id="rich-input"
                        contenteditable="true"
                        data-placeholder="从 Google Docs 或其他富文本编辑器粘贴内容..."
                    ></div>
                    <textarea
                        class="html-input hidden"
                        id="html-input"
                        placeholder="在此输入或粘贴 HTML 代码..."
                    ></textarea>
                </div>
                <div class="drop-hint" id="drop-hint">释放以粘贴内容</div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Markdown 输出</span>
                    <div class="panel-actions">
                        <button class="btn btn-success" id="btn-copy">复制结果</button>
                    </div>
                </div>
                <div class="panel-body">
                    <textarea
                        class="markdown-output"
                        id="markdown-output"
                        placeholder="转换后的 Markdown 将显示在这里..."
                    ></textarea>
                </div>
            </div>
        </div>

        <!-- SEO 工具面板 -->
        <div class="seo-container" id="seo-container">
            <!-- URL/Slug 生成器 -->
            <div class="seo-tool">
                <div class="seo-tool-header">
                    <div class="seo-tool-title">URL Slug 生成器</div>
                    <div class="seo-tool-subtitle">将文字转换为 URL 友好的格式</div>
                </div>
                <div class="seo-tool-body">
                    <div class="seo-input-group">
                        <label for="slug-input">输入文字</label>
                        <input type="text" class="seo-input" id="slug-input" placeholder="输入标题或文字...">
                    </div>
                    <div class="slug-options">
                        <label class="slug-option">
                            <input type="radio" name="slug-style" value="pinyin" checked>
                            拼音转换
                        </label>
                        <label class="slug-option">
                            <input type="radio" name="slug-style" value="english">
                            仅保留英文
                        </label>
                        <label class="slug-option">
                            <input type="radio" name="slug-style" value="encode">
                            URL 编码
                        </label>
                    </div>
                    <div class="seo-output-group">
                        <div class="seo-output-label">
                            <span>生成的 URL Slug</span>
                            <button class="btn btn-primary btn-sm" id="btn-copy-slug">复制</button>
                        </div>
                        <div class="seo-output" id="slug-output">-</div>
                    </div>
                </div>
            </div>

            <!-- Google 搜索预览 -->
            <div class="seo-tool">
                <div class="seo-tool-header">
                    <div class="seo-tool-title">Google 搜索预览</div>
                    <div class="seo-tool-subtitle">预览页面在搜索结果中的显示效果</div>
                </div>
                <div class="seo-tool-body">
                    <div class="seo-input-group">
                        <div class="seo-output-label">
                            <label for="serp-title">页面标题 (Title)</label>
                            <span class="char-count" id="title-count">0/60</span>
                        </div>
                        <input type="text" class="seo-input" id="serp-title" placeholder="输入页面标题..." maxlength="100">
                    </div>
                    <div class="seo-input-group">
                        <div class="seo-output-label">
                            <label for="serp-url">页面 URL</label>
                        </div>
                        <input type="text" class="seo-input" id="serp-url" placeholder="https://example.com/your-page">
                    </div>
                    <div class="seo-input-group">
                        <div class="seo-output-label">
                            <label for="serp-description">页面描述 (Description)</label>
                            <span class="char-count" id="desc-count">0/160</span>
                        </div>
                        <textarea class="seo-input seo-textarea" id="serp-description" placeholder="输入页面描述..." maxlength="300"></textarea>
                    </div>
                    <div class="seo-output-group">
                        <div class="serp-label">搜索结果预览</div>
                        <div class="serp-preview">
                            <a class="serp-preview-title" id="preview-title">页面标题将显示在这里</a>
                            <div class="serp-preview-url" id="preview-url">https://example.com</div>
                            <div class="serp-preview-description" id="preview-description">页面描述将显示在这里。Google 通常会显示大约 155-160 个字符的描述内容。</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // DOM 元素
        const richInput = document.getElementById('rich-input');
        const htmlInput = document.getElementById('html-input');
        const markdownOutput = document.getElementById('markdown-output');
        const modeTabs = document.querySelectorAll('.mode-tab');
        const inputTitle = document.getElementById('input-title');
        const btnClear = document.getElementById('btn-clear');
        const btnCopy = document.getElementById('btn-copy');
        const toast = document.getElementById('toast');
        const dropHint = document.getElementById('drop-hint');

        // 选项元素
        const optGfm = document.getElementById('opt-gfm');
        const optCodeFence = document.getElementById('opt-code-fence');
        const optHeading = document.getElementById('opt-heading');
        const optBullet = document.getElementById('opt-bullet');

        let currentMode = 'rich';

        // 图片计数器（只在清空时重置）
        let imageCounter = 0;

        // 创建 Turndown 实例
        function createTurndownService() {
            // 注意：不再在这里重置 imageCounter，因为粘贴图片时已经设置了索引

            const options = {
                headingStyle: optHeading.value,
                bulletListMarker: optBullet.value,
                codeBlockStyle: optCodeFence.checked ? 'fenced' : 'indented',
                emDelimiter: '*',
                strongDelimiter: '**',
                linkStyle: 'inlined',
            };

            const turndownService = new TurndownService(options);

            // 使用 GFM 插件（用于任务列表、删除线等，但不用其表格处理）
            if (optGfm.checked && window.turndownPluginGfm) {
                // 只使用 strikethrough 和 taskListItems
                turndownService.use(turndownPluginGfm.strikethrough);
                turndownService.use(turndownPluginGfm.taskListItems);
            }

            // 自定义表格处理规则 - 处理 Google Docs 表格
            turndownService.addRule('googleDocsTable', {
                filter: function(node) {
                    return node.nodeName === 'TABLE';
                },
                replacement: function(content, node) {
                    const rows = node.querySelectorAll('tr');
                    if (rows.length === 0) return '';

                    let markdown = '\n\n';
                    let columnCount = 0;

                    rows.forEach((row, rowIndex) => {
                        const cells = row.querySelectorAll('td, th');
                        if (cells.length === 0) return;

                        // 获取列数（第一行决定）
                        if (rowIndex === 0) {
                            columnCount = cells.length;
                        }

                        // 构建行
                        let rowContent = '|';
                        cells.forEach(cell => {
                            // 获取单元格文本，清理换行和多余空格
                            let cellText = cell.textContent.trim()
                                .replace(/\n/g, ' ')
                                .replace(/\s+/g, ' ')
                                .replace(/\|/g, '\\|'); // 转义管道符
                            rowContent += ' ' + cellText + ' |';
                        });
                        markdown += rowContent + '\n';

                        // 第一行后添加分隔符
                        if (rowIndex === 0) {
                            let separator = '|';
                            for (let i = 0; i < columnCount; i++) {
                                separator += ' --- |';
                            }
                            markdown += separator + '\n';
                        }
                    });

                    return markdown + '\n';
                }
            });

            // 处理我们自己插入的图片占位符标记
            turndownService.addRule('imagePlaceholderMarker', {
                filter: function(node) {
                    return node.hasAttribute && node.hasAttribute('data-image-placeholder');
                },
                replacement: function(content, node) {
                    const index = node.getAttribute('data-image-placeholder');
                    const name = node.getAttribute('data-image-name') || '图片' + index;
                    return '\n\n![' + name + '](IMAGE_PLACEHOLDER_' + index + ')\n\n';
                }
            });

            // 处理图片 - 转换为 placeholder（增强版，支持多种图片格式）
            turndownService.addRule('images', {
                filter: function(node) {
                    // 标准 img 标签
                    if (node.nodeName === 'IMG') return true;
                    // picture 元素中的 source
                    if (node.nodeName === 'PICTURE') return true;
                    return false;
                },
                replacement: function(content, node) {
                    // 检查是否已有索引
                    let index = node.getAttribute('data-image-index');
                    if (!index) {
                        imageCounter++;
                        index = imageCounter;
                    }

                    let alt = '图片' + index;

                    if (node.nodeName === 'IMG') {
                        alt = node.getAttribute('alt') || alt;
                    } else if (node.nodeName === 'PICTURE') {
                        const img = node.querySelector('img');
                        if (img) alt = img.getAttribute('alt') || alt;
                    }

                    return '\n\n![' + alt + '](IMAGE_PLACEHOLDER_' + index + ')\n\n';
                }
            });

            // 处理 Google Docs 特殊的图片容器
            // Google Docs 粘贴的图片通常被包裹在特殊结构中
            turndownService.addRule('googleDocsImageContainer', {
                filter: function(node) {
                    // 检查是否包含 Google Docs 图片的各种特征
                    if (node.nodeName === 'SPAN' || node.nodeName === 'DIV' || node.nodeName === 'P') {
                        // 检查内部是否有图片
                        const hasImg = node.querySelector('img');
                        if (hasImg) {
                            // 如果直接子元素只有一个 img，让 img 规则处理
                            if (node.children.length === 1 && node.children[0].nodeName === 'IMG') {
                                return false;
                            }
                            return true;
                        }

                        // 检查 style 中是否有 background-image
                        const style = node.getAttribute('style') || '';
                        if (style.includes('background-image') || style.includes('background:')) {
                            return true;
                        }

                        // Google Docs 有时用 data-* 属性标记图片
                        const attrs = node.attributes;
                        for (let i = 0; i < attrs.length; i++) {
                            const attrName = attrs[i].name.toLowerCase();
                            if (attrName.startsWith('data-') &&
                                (attrName.includes('image') || attrName.includes('src'))) {
                                return true;
                            }
                        }
                    }
                    return false;
                },
                replacement: function(content, node) {
                    // 先检查内部有没有已经处理过的图片标记
                    if (content.includes('IMAGE_PLACEHOLDER_') || content.includes('CHART_PLACEHOLDER_')) {
                        return content;
                    }

                    imageCounter++;
                    const innerImg = node.querySelector('img');
                    const alt = innerImg ? (innerImg.getAttribute('alt') || '图片' + imageCounter) : '图片' + imageCounter;
                    return '\n\n![' + alt + '](IMAGE_PLACEHOLDER_' + imageCounter + ')\n\n';
                }
            });

            // 处理 SVG 图形
            turndownService.addRule('svgImages', {
                filter: 'svg',
                replacement: function(content, node) {
                    imageCounter++;
                    return '\n\n![SVG图形' + imageCounter + '](SVG_PLACEHOLDER_' + imageCounter + ')\n\n';
                }
            });

            // 处理 canvas 元素
            turndownService.addRule('canvasImages', {
                filter: 'canvas',
                replacement: function(content, node) {
                    imageCounter++;
                    return '\n\n![Canvas图形' + imageCounter + '](CANVAS_PLACEHOLDER_' + imageCounter + ')\n\n';
                }
            });

            // 处理 figure 元素（常见的图片容器）
            turndownService.addRule('figureImages', {
                filter: 'figure',
                replacement: function(content, node) {
                    // 如果已经有 placeholder，直接返回
                    if (content.includes('PLACEHOLDER_')) {
                        // 提取 figcaption 作为说明
                        const figcaption = node.querySelector('figcaption');
                        if (figcaption) {
                            return content + '\n*' + figcaption.textContent.trim() + '*\n';
                        }
                        return content;
                    }

                    imageCounter++;
                    const figcaption = node.querySelector('figcaption');
                    const caption = figcaption ? figcaption.textContent.trim() : '';
                    const alt = caption || '图片' + imageCounter;

                    let result = '\n\n![' + alt + '](IMAGE_PLACEHOLDER_' + imageCounter + ')';
                    if (caption) {
                        result += '\n*' + caption + '*';
                    }
                    return result + '\n\n';
                }
            });

            // 处理 object/embed 元素（嵌入内容）
            turndownService.addRule('embeddedContent', {
                filter: ['object', 'embed', 'iframe'],
                replacement: function(content, node) {
                    imageCounter++;
                    const type = node.nodeName.toLowerCase();
                    return '\n\n![嵌入内容' + imageCounter + '](EMBED_PLACEHOLDER_' + imageCounter + ')\n\n';
                }
            });

            // 自定义规则：处理 Google Docs 的代码样式
            turndownService.addRule('googleDocsCode', {
                filter: function(node) {
                    if (node.nodeName === 'SPAN') {
                        const style = node.getAttribute('style') || '';
                        const fontFamily = style.match(/font-family:\s*["']?([^;"']+)/i);
                        if (fontFamily) {
                            const font = fontFamily[1].toLowerCase();
                            return font.includes('mono') ||
                                   font.includes('courier') ||
                                   font.includes('consolas') ||
                                   font.includes('source code');
                        }
                    }
                    return false;
                },
                replacement: function(content, node) {
                    // 直接使用原始文本，避免转义问题
                    const text = node.textContent || content;
                    return '`' + text + '`';
                }
            });

            // 处理 pre 和 code 标签
            turndownService.addRule('codeBlocks', {
                filter: ['pre'],
                replacement: function(content, node) {
                    const language = node.getAttribute('data-language') ||
                                   node.className.match(/language-(\w+)/)?.[1] || '';
                    // 直接使用 textContent 避免转义问题
                    const code = node.textContent || '';
                    if (optCodeFence.checked) {
                        return '\n\n```' + language + '\n' + code.trim() + '\n```\n\n';
                    } else {
                        return '\n\n    ' + code.trim().replace(/\n/g, '\n    ') + '\n\n';
                    }
                }
            });

            // 处理 code 标签（内联代码）
            turndownService.addRule('inlineCode', {
                filter: function(node) {
                    return node.nodeName === 'CODE' &&
                           node.parentNode &&
                           node.parentNode.nodeName !== 'PRE';
                },
                replacement: function(content, node) {
                    // 直接使用 textContent
                    return '`' + node.textContent + '`';
                }
            });

            // 处理高亮/背景色文本（可能是代码）
            turndownService.addRule('highlightedCode', {
                filter: function(node) {
                    if (node.nodeName === 'SPAN' || node.nodeName === 'MARK') {
                        const style = node.getAttribute('style') || '';
                        return style.includes('background-color') &&
                               (style.includes('#f') || style.includes('rgb(24'));
                    }
                    return false;
                },
                replacement: function(content, node) {
                    const text = node.textContent || content;
                    if (text.includes('\n')) {
                        return '\n```\n' + text + '\n```\n';
                    }
                    return '`' + text + '`';
                }
            });

            // 移除空的 span 标签
            turndownService.addRule('emptySpan', {
                filter: function(node) {
                    return node.nodeName === 'SPAN' && !node.textContent.trim();
                },
                replacement: function() {
                    return '';
                }
            });

            // 禁用默认的转义规则中对反引号的处理
            turndownService.escape = function(string) {
                return string
                    .replace(/\[/g, '\\[')
                    .replace(/\]/g, '\\]');
                    // 不再转义反引号和其他字符
            };

            return turndownService;
        }

        // 预处理 HTML，标记所有图片相关元素
        function preprocessHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            let imgIndex = 0;

            // 查找所有可能的图片元素并添加标记
            const selectors = [
                'img',
                'svg',
                'canvas',
                'picture',
                'figure',
                '[style*="background-image"]',
                '[style*="background:"]'
            ];

            selectors.forEach(selector => {
                try {
                    doc.querySelectorAll(selector).forEach(el => {
                        if (!el.hasAttribute('data-md-image-marked')) {
                            el.setAttribute('data-md-image-marked', 'true');
                            el.setAttribute('data-md-image-index', ++imgIndex);
                        }
                    });
                } catch (e) {
                    // 忽略无效选择器错误
                }
            });

            return doc.body.innerHTML;
        }

        // 转换函数
        function convert() {
            let html = '';

            if (currentMode === 'rich' || currentMode === 'debug') {
                html = richInput.innerHTML;
            } else {
                html = htmlInput.value;
            }

            if (!html.trim()) {
                markdownOutput.value = '';
                return;
            }

            // Debug 模式：显示原始 HTML
            if (currentMode === 'debug') {
                // 格式化 HTML 以便查看
                const formatted = html
                    .replace(/></g, '>\n<')
                    .replace(/(<[^>]+>)/g, function(match) {
                        return match;
                    });
                markdownOutput.value = '=== 原始 HTML ===\n\n' + formatted + '\n\n=== 检测到的图片元素 ===\n' + detectImages(html);
                return;
            }

            try {
                // 预处理 HTML
                const processedHtml = preprocessHtml(html);

                const turndownService = createTurndownService();
                let markdown = turndownService.turndown(processedHtml);

                // 清理多余的反斜杠转义（特别是代码块中的）
                markdown = markdown
                    // 修复代码块中的转义反引号 \` -> `
                    .replace(/\\`/g, '`')
                    // 修复转义的反斜杠
                    .replace(/\\\\/g, '\\')
                    // 修复转义的星号（在代码块内不需要转义）
                    .replace(/\\\*/g, '*')
                    // 修复转义的下划线
                    .replace(/\\_/g, '_')
                    // 清理多余的空行
                    .replace(/\n{3,}/g, '\n\n')
                    .trim();

                markdownOutput.value = markdown;
            } catch (error) {
                console.error('转换错误:', error);
                markdownOutput.value = '转换出错: ' + error.message;
            }
        }

        // 检测 HTML 中的图片元素（用于调试）
        function detectImages(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            let result = [];

            // 检测各类图片元素
            const imgs = doc.querySelectorAll('img');
            if (imgs.length > 0) {
                result.push(`发现 ${imgs.length} 个 <img> 标签`);
                imgs.forEach((img, i) => {
                    const src = img.getAttribute('src') || '';
                    const srcPreview = src.length > 100 ? src.substring(0, 100) + '...' : src;
                    result.push(`  [${i+1}] src: ${srcPreview}`);
                });
            }

            const svgs = doc.querySelectorAll('svg');
            if (svgs.length > 0) {
                result.push(`发现 ${svgs.length} 个 <svg> 元素`);
            }

            const bgImages = doc.querySelectorAll('[style*="background-image"], [style*="background:"]');
            if (bgImages.length > 0) {
                result.push(`发现 ${bgImages.length} 个带背景图的元素`);
            }

            const figures = doc.querySelectorAll('figure');
            if (figures.length > 0) {
                result.push(`发现 ${figures.length} 个 <figure> 元素`);
            }

            if (result.length === 0) {
                result.push('未检测到任何图片元素');
                result.push('');
                result.push('提示：Google Docs 的图片可能没有被复制。');
                result.push('建议：先将图片上传到图床，再手动添加图片链接。');
            }

            return result.join('\n');
        }

        // 显示 Toast
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // 切换模式
        modeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                modeTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentMode = tab.dataset.mode;

                if (currentMode === 'rich') {
                    richInput.classList.remove('hidden');
                    htmlInput.classList.add('hidden');
                    inputTitle.textContent = '输入 (粘贴富文本)';
                } else if (currentMode === 'html') {
                    richInput.classList.add('hidden');
                    htmlInput.classList.remove('hidden');
                    inputTitle.textContent = '输入 (HTML 代码)';
                } else if (currentMode === 'debug') {
                    richInput.classList.remove('hidden');
                    htmlInput.classList.add('hidden');
                    inputTitle.textContent = '输入 (调试模式 - 查看原始 HTML)';
                }

                convert();
            });
        });

        // 富文本输入事件
        richInput.addEventListener('input', () => {
            convert();
        });

        richInput.addEventListener('paste', (e) => {
            const clipboardData = e.clipboardData || window.clipboardData;

            // 检查是否有图片文件
            const items = clipboardData.items;
            let hasImageFile = false;

            if (items) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        hasImageFile = true;
                        break;
                    }
                }
            }

            if (hasImageFile) {
                // 阻止默认粘贴行为
                e.preventDefault();

                // 处理所有图片
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        imageCounter++;
                        const file = items[i].getAsFile();
                        const imgName = file.name || '图片' + imageCounter;

                        // 创建一个带有 data-placeholder 属性的图片标记
                        const placeholder = document.createElement('div');
                        placeholder.setAttribute('data-image-placeholder', imageCounter);
                        placeholder.setAttribute('data-image-name', imgName);
                        placeholder.className = 'image-placeholder-marker';
                        placeholder.textContent = `[图片: ${imgName}]`;
                        placeholder.style.cssText = 'background:#e3f2fd;padding:8px 12px;margin:8px 0;border-radius:4px;border:1px dashed #2196f3;color:#1565c0;font-size:14px;';

                        // 插入占位符
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            range.deleteContents();
                            range.insertNode(placeholder);
                            range.setStartAfter(placeholder);
                            range.collapse(true);
                            selection.removeAllRanges();
                            selection.addRange(range);
                        } else {
                            richInput.appendChild(placeholder);
                        }
                    }
                }

                setTimeout(convert, 0);
            } else {
                // 没有图片文件，让默认的粘贴行为发生
                setTimeout(() => {
                    // 粘贴后检查是否有 img 标签并添加标记
                    const imgs = richInput.querySelectorAll('img:not([data-processed])');
                    imgs.forEach(img => {
                        imageCounter++;
                        img.setAttribute('data-processed', 'true');
                        img.setAttribute('data-image-index', imageCounter);

                        // 如果图片是 base64 或 blob，添加视觉标记
                        const src = img.getAttribute('src') || '';
                        if (src.startsWith('data:') || src.startsWith('blob:')) {
                            img.style.outline = '2px solid #2196f3';
                            img.title = '图片' + imageCounter + ' (将转换为占位符)';
                        }
                    });
                    convert();
                }, 100);
            }
        });

        // HTML 输入事件
        htmlInput.addEventListener('input', convert);

        // 清空按钮
        btnClear.addEventListener('click', () => {
            if (currentMode === 'rich' || currentMode === 'debug') {
                richInput.innerHTML = '';
            } else {
                htmlInput.value = '';
            }
            markdownOutput.value = '';
            imageCounter = 0; // 重置图片计数器
        });

        // 复制按钮
        btnCopy.addEventListener('click', async () => {
            const text = markdownOutput.value;
            if (!text) {
                showToast('没有可复制的内容');
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                showToast('已复制到剪贴板!');
            } catch (err) {
                // 降级方案
                markdownOutput.select();
                document.execCommand('copy');
                showToast('已复制到剪贴板!');
            }
        });

        // 选项变化时重新转换
        [optGfm, optCodeFence, optHeading, optBullet].forEach(opt => {
            opt.addEventListener('change', convert);
        });

        // 拖拽支持
        const inputPanel = document.querySelector('.input-panel');

        inputPanel.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropHint.classList.add('show');
        });

        inputPanel.addEventListener('dragleave', () => {
            dropHint.classList.remove('show');
        });

        inputPanel.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropHint.classList.remove('show');

            const html = e.dataTransfer.getData('text/html');
            const text = e.dataTransfer.getData('text/plain');

            if (html) {
                if (currentMode === 'rich') {
                    richInput.innerHTML = html;
                } else {
                    htmlInput.value = html;
                }
            } else if (text) {
                if (currentMode === 'rich') {
                    richInput.textContent = text;
                } else {
                    htmlInput.value = text;
                }
            }

            convert();
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Shift + C: 复制结果
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                btnCopy.click();
            }
        });

        // ========== SEO 工具功能 ==========

        // SEO 相关 DOM 元素
        const seoContainer = document.getElementById('seo-container');
        const mainContent = document.querySelector('.main-content');
        const optionsPanel = document.querySelector('.options');

        // Slug 生成器元素
        const slugInput = document.getElementById('slug-input');
        const slugOutput = document.getElementById('slug-output');
        const btnCopySlug = document.getElementById('btn-copy-slug');

        // SERP 预览元素
        const serpTitle = document.getElementById('serp-title');
        const serpUrl = document.getElementById('serp-url');
        const serpDescription = document.getElementById('serp-description');
        const titleCount = document.getElementById('title-count');
        const descCount = document.getElementById('desc-count');
        const previewTitle = document.getElementById('preview-title');
        const previewUrl = document.getElementById('preview-url');
        const previewDescription = document.getElementById('preview-description');

        // 简化的拼音映射表（常用汉字）
        const pinyinMap = {
            '的': 'de', '一': 'yi', '是': 'shi', '在': 'zai', '不': 'bu', '了': 'le', '有': 'you', '和': 'he',
            '人': 'ren', '这': 'zhe', '中': 'zhong', '大': 'da', '为': 'wei', '上': 'shang', '个': 'ge',
            '国': 'guo', '我': 'wo', '以': 'yi', '要': 'yao', '他': 'ta', '时': 'shi', '来': 'lai',
            '用': 'yong', '们': 'men', '生': 'sheng', '到': 'dao', '作': 'zuo', '地': 'di', '于': 'yu',
            '出': 'chu', '就': 'jiu', '分': 'fen', '对': 'dui', '成': 'cheng', '会': 'hui', '可': 'ke',
            '主': 'zhu', '发': 'fa', '年': 'nian', '动': 'dong', '同': 'tong', '工': 'gong', '也': 'ye',
            '能': 'neng', '下': 'xia', '过': 'guo', '子': 'zi', '说': 'shuo', '产': 'chan', '种': 'zhong',
            '面': 'mian', '而': 'er', '方': 'fang', '后': 'hou', '多': 'duo', '定': 'ding', '行': 'xing',
            '学': 'xue', '法': 'fa', '所': 'suo', '民': 'min', '得': 'de', '经': 'jing', '十': 'shi',
            '三': 'san', '之': 'zhi', '进': 'jin', '着': 'zhe', '等': 'deng', '部': 'bu', '度': 'du',
            '家': 'jia', '电': 'dian', '力': 'li', '里': 'li', '如': 'ru', '水': 'shui', '化': 'hua',
            '高': 'gao', '自': 'zi', '二': 'er', '理': 'li', '起': 'qi', '小': 'xiao', '物': 'wu',
            '现': 'xian', '实': 'shi', '加': 'jia', '量': 'liang', '都': 'dou', '两': 'liang', '体': 'ti',
            '制': 'zhi', '机': 'ji', '当': 'dang', '使': 'shi', '点': 'dian', '从': 'cong', '业': 'ye',
            '本': 'ben', '去': 'qu', '把': 'ba', '性': 'xing', '好': 'hao', '应': 'ying', '开': 'kai',
            '它': 'ta', '合': 'he', '还': 'hai', '因': 'yin', '由': 'you', '其': 'qi', '些': 'xie',
            '然': 'ran', '前': 'qian', '外': 'wai', '天': 'tian', '政': 'zheng', '四': 'si', '日': 'ri',
            '那': 'na', '社': 'she', '义': 'yi', '事': 'shi', '平': 'ping', '形': 'xing', '相': 'xiang',
            '全': 'quan', '表': 'biao', '间': 'jian', '样': 'yang', '与': 'yu', '关': 'guan', '各': 'ge',
            '重': 'zhong', '新': 'xin', '线': 'xian', '内': 'nei', '数': 'shu', '正': 'zheng', '心': 'xin',
            '反': 'fan', '你': 'ni', '明': 'ming', '看': 'kan', '原': 'yuan', '又': 'you', '么': 'me',
            '利': 'li', '比': 'bi', '或': 'huo', '但': 'dan', '质': 'zhi', '气': 'qi', '第': 'di',
            '向': 'xiang', '道': 'dao', '命': 'ming', '此': 'ci', '变': 'bian', '条': 'tiao', '只': 'zhi',
            '没': 'mei', '结': 'jie', '解': 'jie', '问': 'wen', '意': 'yi', '建': 'jian', '月': 'yue',
            '公': 'gong', '无': 'wu', '系': 'xi', '军': 'jun', '很': 'hen', '情': 'qing', '最': 'zui',
            '何': 'he', '则': 'ze', '已': 'yi', '先': 'xian', '代': 'dai', '算': 'suan', '儿': 'er',
            '文': 'wen', '总': 'zong', '次': 'ci', '品': 'pin', '式': 'shi', '活': 'huo', '设': 'she',
            '及': 'ji', '管': 'guan', '特': 'te', '件': 'jian', '长': 'chang', '求': 'qiu', '老': 'lao',
            '头': 'tou', '基': 'ji', '资': 'zi', '边': 'bian', '流': 'liu', '路': 'lu', '级': 'ji',
            '少': 'shao', '图': 'tu', '山': 'shan', '统': 'tong', '接': 'jie', '知': 'zhi', '较': 'jiao',
            '将': 'jiang', '组': 'zu', '见': 'jian', '计': 'ji', '别': 'bie', '她': 'ta', '手': 'shou',
            '角': 'jiao', '期': 'qi', '根': 'gen', '论': 'lun', '运': 'yun', '农': 'nong', '指': 'zhi',
            '几': 'ji', '九': 'jiu', '区': 'qu', '强': 'qiang', '放': 'fang', '决': 'jue', '西': 'xi',
            '被': 'bei', '干': 'gan', '做': 'zuo', '必': 'bi', '战': 'zhan', '先': 'xian', '回': 'hui',
            '网': 'wang', '站': 'zhan', '页': 'ye', '教': 'jiao', '程': 'cheng', '技': 'ji', '术': 'shu',
            '信': 'xin', '息': 'xi', '安': 'an', '服': 'fu', '务': 'wu', '数': 'shu', '据': 'ju',
            '库': 'ku', '软': 'ruan', '件': 'jian', '硬': 'ying', '盘': 'pan', '存': 'cun', '储': 'chu',
            '内': 'nei', '存': 'cun', '处': 'chu', '理': 'li', '器': 'qi', '显': 'xian', '示': 'shi',
            '输': 'shu', '入': 'ru', '输': 'shu', '出': 'chu', '端': 'duan', '口': 'kou', '协': 'xie',
            '议': 'yi', '传': 'chuan', '输': 'shu', '速': 'su', '率': 'lv', '带': 'dai', '宽': 'kuan',
            '连': 'lian', '接': 'jie', '断': 'duan', '开': 'kai', '关': 'guan', '闭': 'bi', '启': 'qi',
            '停': 'ting', '止': 'zhi', '继': 'ji', '续': 'xu', '完': 'wan', '成': 'cheng', '失': 'shi',
            '败': 'bai', '错': 'cuo', '误': 'wu', '警': 'jing', '告': 'gao', '提': 'ti', '醒': 'xing',
            '注': 'zhu', '意': 'yi', '确': 'que', '认': 'ren', '取': 'qu', '消': 'xiao', '保': 'bao',
            '存': 'cun', '删': 'shan', '除': 'chu', '修': 'xiu', '改': 'gai', '编': 'bian', '辑': 'ji',
            '复': 'fu', '制': 'zhi', '粘': 'zhan', '贴': 'tie', '剪': 'jian', '切': 'qie', '撤': 'che',
            '销': 'xiao', '恢': 'hui', '搜': 'sou', '索': 'suo', '查': 'cha', '找': 'zhao', '替': 'ti',
            '换': 'huan', '打': 'da', '印': 'yin', '预': 'yu', '览': 'lan', '导': 'dao', '出': 'chu',
            '导': 'dao', '入': 'ru', '上': 'shang', '传': 'chuan', '下': 'xia', '载': 'zai', '安': 'an',
            '装': 'zhuang', '卸': 'xie', '载': 'zai', '更': 'geng', '新': 'xin', '升': 'sheng', '级': 'ji',
            '版': 'ban', '本': 'ben', '功': 'gong', '能': 'neng', '模': 'mo', '块': 'kuai', '插': 'cha',
            '扩': 'kuo', '展': 'zhan', '配': 'pei', '置': 'zhi', '选': 'xuan', '项': 'xiang', '参': 'can',
            '默': 'mo', '认': 'ren', '自': 'zi', '定': 'ding', '义': 'yi', '标': 'biao', '签': 'qian',
            '分': 'fen', '类': 'lei', '排': 'pai', '序': 'xu', '筛': 'shai', '选': 'xuan', '过': 'guo',
            '滤': 'lv', '显': 'xian', '隐': 'yin', '藏': 'cang', '折': 'zhe', '叠': 'die', '展': 'zhan',
            '收': 'shou', '起': 'qi', '放': 'fang', '缩': 'suo', '最': 'zui', '窗': 'chuang', '全': 'quan',
            '屏': 'ping', '退': 'tui', '返': 'fan', '跳': 'tiao', '转': 'zhuan', '链': 'lian', '锚': 'mao',
            '书': 'shu', '历': 'li', '史': 'shi', '记': 'ji', '录': 'lu', '日': 'ri', '志': 'zhi',
            '报': 'bao', '表': 'biao', '统': 'tong', '计': 'ji', '分': 'fen', '析': 'xi', '图': 'tu',
            '表': 'biao', '饼': 'bing', '柱': 'zhu', '状': 'zhuang', '曲': 'qu', '线': 'xian', '散': 'san',
            '点': 'dian', '雷': 'lei', '达': 'da', '热': 're', '力': 'li', '树': 'shu', '甘': 'gan',
            '特': 'te', '仪': 'yi', '表': 'biao', '盘': 'pan', '进': 'jin', '度': 'du', '百': 'bai',
            '千': 'qian', '万': 'wan', '亿': 'yi', '零': 'ling', '五': 'wu', '六': 'liu', '七': 'qi',
            '八': 'ba', '星': 'xing', '期': 'qi', '周': 'zhou', '末': 'mo', '假': 'jia', '节': 'jie',
            '今': 'jin', '昨': 'zuo', '明': 'ming', '早': 'zao', '晚': 'wan', '午': 'wu', '秒': 'miao',
            '钟': 'zhong', '刻': 'ke', '整': 'zheng', '半': 'ban', '春': 'chun', '夏': 'xia', '秋': 'qiu',
            '冬': 'dong', '东': 'dong', '南': 'nan', '北': 'bei', '左': 'zuo', '右': 'you', '里': 'li',
            '米': 'mi', '公': 'gong', '斤': 'jin', '克': 'ke', '吨': 'dun', '升': 'sheng', '毫': 'hao',
            '厘': 'li', '元': 'yuan', '角': 'jiao', '美': 'mei', '欧': 'ou', '英': 'ying', '镑': 'bang',
            '韩': 'han', '币': 'bi', '汇': 'hui', '兑': 'dui', '价': 'jia', '格': 'ge', '折': 'zhe',
            '扣': 'kou', '优': 'you', '惠': 'hui', '促': 'cu', '销': 'xiao', '限': 'xian', '免': 'mian',
            '费': 'fei', '付': 'fu', '款': 'kuan', '支': 'zhi', '收': 'shou', '退': 'tui', '订': 'ding',
            '单': 'dan', '购': 'gou', '物': 'wu', '车': 'che', '结': 'jie', '账': 'zhang', '发': 'fa',
            '票': 'piao', '邮': 'you', '寄': 'ji', '快': 'kuai', '递': 'di', '物': 'wu', '跟': 'gen',
            '踪': 'zong', '签': 'qian', '收': 'shou', '评': 'ping', '论': 'lun', '好': 'hao', '评': 'ping',
            '差': 'cha', '星': 'xing', '推': 'tui', '荐': 'jian', '热': 'hao', '门': 'men', '畅': 'chang',
            '销': 'xiao', '排': 'pai', '行': 'xing', '榜': 'bang', '首': 'shou', '精': 'jing', '选': 'xuan',
            '必': 'bi', '买': 'mai', '卖': 'mai', '租': 'zu', '借': 'jie', '换': 'huan', '送': 'song',
            '礼': 'li', '赠': 'zeng', '品': 'pin', '样': 'yang', '试': 'shi', '用': 'yong', '体': 'ti',
            '验': 'yan', '反': 'fan', '馈': 'kui', '客': 'ke', '户': 'hu', '会': 'hui', '员': 'yuan',
            '积': 'ji', '等': 'deng', '普': 'pu', '通': 'tong', '黄': 'huang', '金': 'jin', '白': 'bai',
            '银': 'yin', '铜': 'tong', '钻': 'zuan', '石': 'shi', '皇': 'huang', '冠': 'guan', '至': 'zhi',
            '尊': 'zun', '贵': 'gui', '宾': 'bin', '专': 'zhuan', '属': 'shu', '私': 'si', '密': 'mi',
            '秘': 'mi', '独': 'du', '享': 'xiang', '定': 'ding', '顶': 'ding', '超': 'chao', '豪': 'hao',
            '华': 'hua', '奢': 'she', '侈': 'chi', '简': 'jian', '约': 'yue', '时': 'shi', '尚': 'shang',
            '潮': 'chao', '流': 'liu', '复': 'fu', '古': 'gu', '典': 'dian', '雅': 'ya', '清': 'qing',
            '森': 'sen', '系': 'xi', '工': 'gong', '原': 'yuan', '创': 'chuang', '设': 'she', '师': 'shi',
            '匠': 'jiang', '造': 'zao', '智': 'zhi', '云': 'yun', '端': 'duan', '联': 'lian', '万': 'wan',
            '区': 'qu', '块': 'kuai', '链': 'lian', '元': 'yuan', '宇': 'yu', '宙': 'zhou', '虚': 'xu',
            '拟': 'ni', '现': 'xian', '实': 'shi', '增': 'zeng', '强': 'qiang', '混': 'hun', '合': 'he',
            '脑': 'nao', '接': 'jie', '口': 'kou', '深': 'shen', '习': 'xi', '神': 'shen', '经': 'jing',
            '算': 'suan', '卷': 'juan', '循': 'xun', '环': 'huan', '注': 'zhu', '力': 'li', '生': 'sheng',
            '成': 'cheng', '对': 'dui', '抗': 'kang', '迁': 'qian', '移': 'yi', '微': 'wei', '调': 'tiao',
            '提': 'ti', '示': 'shi', '语': 'yu', '言': 'yan', '模': 'mo', '型': 'xing', '大': 'da',
            '基': 'ji', '座': 'zuo', '问': 'wen', '答': 'da', '聊': 'liao', '助': 'zhu', '写': 'xie',
            '翻': 'fan', '译': 'yi', '摘': 'zhai', '要': 'yao', '情': 'qing', '感': 'gan', '意': 'yi',
            '图': 'tu', '识': 'shi', '实': 'shi', '命': 'ming', '名': 'ming', '检': 'jian', '测': 'ce',
            '目': 'mu', '跟': 'gen', '语': 'yu', '音': 'yin', '识': 'shi', '合': 'he', '克': 'ke',
            '隆': 'long', '变': 'bian', '声': 'sheng', '视': 'shi', '频': 'pin', '剪': 'jian', '辑': 'ji',
            '特': 'te', '效': 'xiao', '滤': 'lv', '镜': 'jing', '美': 'mei', '颜': 'yan', '瘦': 'shou',
            '脸': 'lian', '磨': 'mo', '皮': 'pi', '祛': 'qu', '斑': 'ban', '亮': 'liang', '眼': 'yan',
            '红': 'hong', '唇': 'chun', '贴': 'tie', '纸': 'zhi', '背': 'bei', '景': 'jing', '虚': 'xu',
            '化': 'hua', '抠': 'kou', '图': 'tu', '证': 'zheng', '照': 'zhao', '身': 'shen', '份': 'fen',
            '护': 'hu', '照': 'zhao', '驾': 'jia', '执': 'zhi', '社': 'she', '保': 'bao', '卡': 'ka',
            '银': 'yin', '行': 'xing', '信': 'xin', '用': 'yong', '借': 'jie', '储': 'chu', '蓄': 'xu',
            '活': 'huo', '定': 'ding', '期': 'qi', '利': 'li', '息': 'xi', '复': 'fu', '利': 'li',
            '本': 'ben', '金': 'jin', '收': 'shou', '益': 'yi', '风': 'feng', '险': 'xian', '投': 'tou',
            '资': 'zi', '理': 'li', '财': 'cai', '股': 'gu', '票': 'piao', '基': 'ji', '金': 'jin',
            '债': 'zhai', '券': 'quan', '期': 'qi', '货': 'huo', '外': 'wai', '汇': 'hui', '黄': 'huang',
            '房': 'fang', '产': 'chan', '保': 'bao', '险': 'xian', '养': 'yang', '老': 'lao', '医': 'yi',
            '疗': 'liao', '意': 'yi', '外': 'wai', '财': 'cai', '重': 'zhong', '疾': 'ji', '寿': 'shou',
            '车': 'che', '责': 'ze', '任': 'ren', '三': 'san', '者': 'zhe', '盗': 'dao', '抢': 'qiang',
            '玻': 'bo', '璃': 'li', '划': 'hua', '痕': 'hen', '涉': 'she', '水': 'shui', '自': 'zi',
            '燃': 'ran', '交': 'jiao', '通': 'tong', '事': 'shi', '故': 'gu', '违': 'wei', '章': 'zhang',
            '罚': 'fa', '扣': 'kou', '驾': 'jia', '吊': 'diao', '销': 'xiao', '酒': 'jiu', '驾': 'jia',
            '醉': 'zui', '超': 'chao', '速': 'su', '闯': 'chuang', '灯': 'deng', '逆': 'ni', '行': 'xing',
            '压': 'ya', '停': 'ting', '靠': 'kao', '掉': 'diao', '头': 'tou', '变': 'bian', '道': 'dao',
            '加': 'jia', '塞': 'sai', '插': 'cha', '队': 'dui', '别': 'bie', '占': 'zhan', '道': 'dao'
        };

        // 文字转 Slug
        function textToSlug(text, style) {
            if (!text) return '-';

            text = text.trim();

            switch (style) {
                case 'pinyin':
                    // 转拼音
                    let pinyin = '';
                    for (let char of text) {
                        if (pinyinMap[char]) {
                            pinyin += pinyinMap[char] + '-';
                        } else if (/[a-zA-Z0-9]/.test(char)) {
                            pinyin += char.toLowerCase();
                        } else if (/\s/.test(char)) {
                            pinyin += '-';
                        }
                        // 忽略其他字符
                    }
                    // 清理多余的横线
                    return pinyin.replace(/-+/g, '-').replace(/^-|-$/g, '') || '-';

                case 'english':
                    // 仅保留英文和数字
                    return text
                        .toLowerCase()
                        .replace(/[^a-z0-9\s]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '') || '-';

                case 'encode':
                    // URL 编码（保留原文）
                    return text
                        .toLowerCase()
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '');

                default:
                    return '-';
            }
        }

        // 更新 Slug
        function updateSlug() {
            const text = slugInput.value;
            const style = document.querySelector('input[name="slug-style"]:checked').value;
            const slug = textToSlug(text, style);
            slugOutput.textContent = slug;
        }

        // 更新 SERP 预览
        function updateSerpPreview() {
            const title = serpTitle.value || '页面标题将显示在这里';
            const url = serpUrl.value || 'https://example.com';
            const description = serpDescription.value || '页面描述将显示在这里。Google 通常会显示大约 155-160 个字符的描述内容。';

            previewTitle.textContent = title;
            previewUrl.textContent = url;
            previewDescription.textContent = description;

            // 更新字符计数
            const titleLen = serpTitle.value.length;
            const descLen = serpDescription.value.length;

            titleCount.textContent = `${titleLen}/60`;
            titleCount.classList.remove('warning', 'danger');
            if (titleLen > 60) {
                titleCount.classList.add('danger');
            } else if (titleLen > 50) {
                titleCount.classList.add('warning');
            }

            descCount.textContent = `${descLen}/160`;
            descCount.classList.remove('warning', 'danger');
            if (descLen > 160) {
                descCount.classList.add('danger');
            } else if (descLen > 140) {
                descCount.classList.add('warning');
            }
        }

        // 复制 Slug
        btnCopySlug.addEventListener('click', async () => {
            const slug = slugOutput.textContent;
            if (slug === '-') {
                showToast('没有可复制的内容');
                return;
            }
            try {
                await navigator.clipboard.writeText(slug);
                showToast('已复制到剪贴板!');
            } catch (err) {
                showToast('复制失败');
            }
        });

        // Slug 输入事件
        slugInput.addEventListener('input', updateSlug);
        document.querySelectorAll('input[name="slug-style"]').forEach(radio => {
            radio.addEventListener('change', updateSlug);
        });

        // SERP 输入事件
        serpTitle.addEventListener('input', updateSerpPreview);
        serpUrl.addEventListener('input', updateSerpPreview);
        serpDescription.addEventListener('input', updateSerpPreview);

        // 更新模式切换逻辑以支持 SEO 模式
        const originalModeHandler = modeTabs[0].onclick;
        modeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const mode = tab.dataset.mode;

                if (mode === 'seo') {
                    // 隐藏 Markdown 相关内容
                    mainContent.classList.add('hidden');
                    optionsPanel.classList.add('hidden');
                    seoContainer.classList.add('active');
                } else {
                    // 显示 Markdown 相关内容
                    mainContent.classList.remove('hidden');
                    optionsPanel.classList.remove('hidden');
                    seoContainer.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
